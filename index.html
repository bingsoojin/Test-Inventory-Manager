<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <title>Inventory Manager</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #fff; color: #000; }
        h1 { font-size: 32px; font-weight: bold; color: #000; text-align: center; margin-bottom: 20px; }
        .dark-mode h1 { color: #f4f4f4; }
        input, select, button { margin: 5px; padding: 8px; width: 300px; }
        label { display: inline-block; width: 150px; font-weight: bold; }
        .form-line { display: flex; align-items: center; margin-bottom: 10px; }
        .error-msg { color: red; font-size: 12px; margin-left: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background-color: #f4f4f4; }
        .dark-mode { background-color: #121212; color: #f4f4f4; }
        .dark-mode table th { background-color: #333; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .left-controls { display: flex; gap: 10px; }
        .right-controls { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background-color: #eee; color: #000; border: 1px solid #ccc; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
        .dark-mode .icon-btn { background-color: #444; color: #fff; border: 1px solid #888; }
        th:nth-child(2), td:nth-child(2) { width: 18%; }
        th:nth-child(3), td:nth-child(3) { width: 22%; }
        th:nth-child(4), td:nth-child(4) { width: 10%; }
        th:nth-child(5), td:nth-child(5) { width: 14%; }
        th:nth-child(6), td:nth-child(6) { width: auto; }
        th:nth-child(7), td:nth-child(7) { width: 6%; }
        th:nth-child(8), td:nth-child(8) { width: 10%; }
        th:nth-child(9), td:nth-child(9) { width: 10%; }
        th:nth-child(10), td:nth-child(10) { width: 6%; }
        button.small-btn { padding: 2px 4px; font-size: 10px; width: auto; }
    </style>
</head>
<body>
    <h1>Inventory Management</h1>
    <div class='top-bar'>
        <div class='left-controls'>
            <input type='text' id='skuInput' placeholder='Scan or Enter SKU' autofocus>
            <button onclick='checkSKU()'>Check</button>
        </div>
        <div class='right-controls'>
            <button onclick='exportExcel()'>Export Excel</button>
            <button onclick='exportJSON()'>Export JSON</button>
            <input type='file' id='importFile' style='display:none' accept='.json,.xlsx' onchange='importFile(event)'>
            <button onclick="document.getElementById('importFile').click()">Import from file</button>
            <button class='icon-btn' onclick='toggleDarkMode()' title='Toggle Dark Mode'>☀/☾</button>
        </div>
    </div>
    <div id='formContainer' style='margin-top:20px;'></div>
    <table id='inventoryTable'>
        <thead>
            <tr>
                <th>SKU</th><th>Name</th><th>Description</th><th>Reference</th><th>Producer</th><th>Qty</th><th>Expiry</th><th>Type</th><th>Status</th><th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src='https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js'></script>
    <script>
        let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
        let editIndex = null;

        function saveInventory() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            renderTable();
        }

        function renderTable() {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';
            const sortedInventory = [...inventory].reverse();
            sortedInventory.forEach((item) => {
                const row = `<tr>
                    <td>${item.sku}</td>
                    <td>${item.name}</td>
                    <td>${item.description}</td>
                    <td>${item.reference}</td>
                    <td>${item.producer}</td>
                    <td>${item.qty}</td>
                    <td>${item.expiry}</td>
                    <td>${item.type}</td>
                    <td>${item.status}</td>
                    <td><button class='small-btn' onclick='editProduct(${inventory.indexOf(item)})'>Edit</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function formatExpiry(input) {
            let val = input.value.replace(/[^0-9]/g, '');
            if (val.length === 8) {
                input.value = val.slice(0,4) + '/' + val.slice(4,6) + '/' + val.slice(6);
            }
        }

        function validateAndSubmit(type) {
            const form = document.getElementById(type === 'add' ? 'addForm' : 'editForm');
            let valid = true;
            form.querySelectorAll('input, select').forEach(field => {
                if (!field.value.trim() || field.value === 'Select') {
                    field.style.border = '2px solid red';
                    valid = false;
                } else {
                    field.style.border = '';
                }
            });
            if (valid) {
                type === 'add' ? addProduct() : saveEdit(editIndex);
            }
        }

        function checkSKU() {
            const skuInput = document.getElementById('skuInput');
            const sku = skuInput.value.trim();
            if (!sku) return;
            const existing = inventory.find(item => item.sku === sku);
            const container = document.getElementById('formContainer');
            if (existing) {
                container.innerHTML = `<h3>Edit Product</h3>
                    <form id='editForm'>
                        <div class='form-line'><label>SKU:</label><input name='sku' value='${existing.sku}' readonly></div>
                        <div class='form-line'><label>Name:</label><input name='name' value='${existing.name}' required></div>
                        <div class='form-line'><label>Description:</label><input name='description' value='${existing.description}' required></div>
                        <div class='form-line'><label>Reference:</label><input name='reference' value='${existing.reference}' required></div>
                        <div class='form-line'><label>Producer:</label><input name='producer' value='${existing.producer}' required></div>
                        <div class='form-line'><label>Quantity:</label><input name='qty' type='number' value='${existing.qty}' required></div>
                        <div class='form-line'><label>Expiry:</label><input name='expiry' value='${existing.expiry}' onblur='formatExpiry(this)' required></div>
                        <div class='form-line'><label>Type of consumable:</label><select name='type' required>
                            <option value='Select'>Select</option>
                            <option ${existing.type==='Tubing'?'selected':''}>Tubing</option>
                            <option ${existing.type==='Dressing'?'selected':''}>Dressing</option>
                            <option ${existing.type==='Sample vial'?'selected':''}>Sample vial</option>
                            <option ${existing.type==='Metals'?'selected':''}>Metals</option>
                            <option ${existing.type==='Syringe'?'selected':''}>Syringe</option>
                            <option ${existing.type==='Needle'?'selected':''}>Needle</option>
                            <option ${existing.type==='Other'?'selected':''}>Other</option>
                        </select></div>
                        <div class='form-line'><label>Status:</label><select name='status' required>
                            <option value='Select'>Select</option>
                            <option ${existing.status==='Sealed'?'selected':''}>Sealed</option>
                            <option ${existing.status==='Unsealed'?'selected':''}>Unsealed</option>
                            <option ${existing.status==='N/A'?'selected':''}>N/A</option>
                            <option ${existing.status==='Damaged'?'selected':''}>Damaged</option>
                        </select></div>
                        <button type='button' onclick='validateAndSubmit("edit")'>Save Changes</button>
                        <button type='button' onclick='cancelEdit()'>Cancel</button>
                    </form>`;
                editIndex = inventory.indexOf(existing);
                attachEnterListeners('edit');
            } else {
                container.innerHTML = `<h3>Add New Product</h3>
                    <form id='addForm'>
                        <div class='form-line'><label>Name:</label><input name='name' required></div>
                        <div class='form-line'><label>Description:</label><input name='description' required></div>
                        <div class='form-line'><label>Reference:</label><input name='reference' required></div>
                        <div class='form-line'><label>Producer:</label><input name='producer' required></div>
                        <div class='form-line'><label>Quantity:</label><input name='qty' type='number' required></div>
                        <div class='form-line'><label>Expiry:</label><input name='expiry' placeholder='YYYY/MM/DD' onblur='formatExpiry(this)' required></div>
                        <div class='form-line'><label>Type of consumable:</label><select name='type' required>
                            <option value='Select'>Select</option>
                            <option value='Tubing'>Tubing</option>
                            <option value='Dressing'>Dressing</option>
                            <option value='Sample vial'>Sample vial</option>
                            <option value='Metals'>Metals</option>
                            <option value='Syringe'>Syringe</option>
                            <option value='Needle'>Needle</option>
                            <option value='Other'>Other</option>
                        </select></div>
                        <div class='form-line'><label>Status:</label><select name='status' required>
                            <option value='Select'>Select</option>
                            <option value='Sealed'>Sealed</option>
                            <option value='Unsealed'>Unsealed</option>
                            <option value='N/A'>N/A</option>
                            <option value='Damaged'>Damaged</option>
                        </select></div>
                        <input type='hidden' name='sku' value='${sku}'>
                        <button type='button' onclick='validateAndSubmit("add")'>Add Product</button>
                        <button type='button' onclick='cancelEdit()'>Cancel</button>
                    </form>`;
                attachEnterListeners('add');
            }
            skuInput.value = '';
        }

        function attachEnterListeners(type) {
            const form = document.getElementById(type === 'add' ? 'addForm' : 'editForm');
            const fields = Array.from(form.querySelectorAll('input, select'));
            fields.forEach((field, idx) => {
                field.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (idx < fields.length - 1) {
                            fields[idx + 1].focus();
                        } else {
                            validateAndSubmit(type);
                        }
                    }
                });
            });
        }

        function cancelEdit() {
            document.getElementById('formContainer').innerHTML = '';
            document.getElementById('skuInput').focus();
        }

        function updateExpiry(sku) {
            const newExpiry = document.getElementById('newExpiry').value.trim();
            if (newExpiry) {
                const item = inventory.find(i => i.sku === sku);
                item.expiry = newExpiry;
                saveInventory();
                document.getElementById('formContainer').innerHTML = '';
                document.getElementById('skuInput').focus();
            }
        }

        function addProduct() {
            const form = document.getElementById('addForm');
            const data = Object.fromEntries(new FormData(form).entries());
            data.qty = parseInt(data.qty);
            inventory.push(data);
            saveInventory();
            cancelEdit();
        }

        /* --- NEW: Edit button functionality wired up, reusing existing edit form pattern --- */
        function editProduct(index) {
            const item = inventory[index];
            if (!item) return;
            const container = document.getElementById('formContainer');
            container.innerHTML = `<h3>Edit Product</h3>
                <form id='editForm'>
                    <div class='form-line'><label>SKU:</label><input name='sku' value='${item.sku}' readonly></div>
                    <div class='form-line'><label>Name:</label><input name='name' value='${item.name}' required></div>
                    <div class='form-line'><label>Description:</label><input name='description' value='${item.description}' required></div>
                    <div class='form-line'><label>Reference:</label><input name='reference' value='${item.reference}' required></div>
                    <div class='form-line'><label>Producer:</label><input name='producer' value='${item.producer}' required></div>
                    <div class='form-line'><label>Quantity:</label><input name='qty' type='number' value='${item.qty}' required></div>
                    <div class='form-line'><label>Expiry:</label><input name='expiry' value='${item.expiry}' onblur='formatExpiry(this)' required></div>
                    <div class='form-line'><label>Type of consumable:</label><select name='type' required>
                        <option value='Select'>Select</option>
                        <option ${item.type==='Tubing'?'selected':''}>Tubing</option>
                        <option ${item.type==='Dressing'?'selected':''}>Dressing</option>
                        <option ${item.type==='Sample vial'?'selected':''}>Sample vial</option>
                        <option ${item.type==='Metals'?'selected':''}>Metals</option>
                        <option ${item.type==='Syringe'?'selected':''}>Syringe</option>
                        <option ${item.type==='Needle'?'selected':''}>Needle</option>
                        <option ${item.type==='Other'?'selected':''}>Other</option>
                    </select></div>
                    <div class='form-line'><label>Status:</label><select name='status' required>
                        <option value='Select'>Select</option>
                        <option ${item.status==='Sealed'?'selected':''}>Sealed</option>
                        <option ${item.status==='Unsealed'?'selected':''}>Unsealed</option>
                        <option ${item.status==='N/A'?'selected':''}>N/A</option>
                        <option ${item.status==='Damaged'?'selected':''}>Damaged</option>
                    </select></div>
                    <button type='button' onclick='validateAndSubmit("edit")'>Save Changes</button>
                    <button type='button' onclick='cancelEdit()'>Cancel</button>
                </form>`;
            editIndex = index;
            attachEnterListeners('edit');
        }
        /* --- END NEW CODE --- */

        function saveEdit(index) {
            const form = document.getElementById('editForm');
            const data = Object.fromEntries(new FormData(form).entries());
            data.qty = parseInt(data.qty);
            inventory[index] = data;
            saveInventory();
            cancelEdit();
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(inventory);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventory');
            XLSX.writeFile(wb, 'inventory_export.xlsx');
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(inventory)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventory_backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            if (file.name.endsWith('.json')) {
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            inventory = data;
                            saveInventory();
                        } else {
                            alert('Invalid JSON format');
                        }
                    } catch {
                        alert('Error reading JSON file');
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx')) {
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    inventory = jsonData;
                    saveInventory();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        document.getElementById('skuInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkSKU();
            }
        });

        renderTable();
    </script>
</body>
</html>
